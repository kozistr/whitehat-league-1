# WhiteHat League 1 - Demon CTF [![Awesome](https://cdn.rawgit.com/sindresorhus/awesome/d7305f38d29fed78fa85652e3a63e154dd8e8829/media/badge.svg)](https://github.com/sindresorhus/awesome)
Kulkulbed Write-Up - 출제자 풀이
-----------------------------------

## Introduce
* Author : 박광호, 김형찬 ([debukuk](http://debu.kr/), [zer0day](http:/zer0day.tistory.com))
* Field  : Web Hacking & Reverse Engineering
* E-Mail : debukuk154@gmail.com, kozistr@gmail.com
* Date   : 2017-09-12

## Intention
* LFI 필터링을 우회할 수 있는가?
* 웹 소스코드를 이해할 수 있는가?
* 코드순서에 따른 공격이 가능한가?
* Reverse CRC32 연산을 할 수 있는가?
* 플래그 형식은 **Demon{...}**

## Solve
* 로그인페이지와 로그아웃페이지가 있다.

위와 같은 코드가 있다.<br><br>
이제 위 코드를 확인함으로써 php 소스코드가 leak됨을 알 수 있는데 그 말은 즉, LFI 취약점이 발생한다는 것이다.<br>

index.php?page=index 에 접근하여 소스를 보면 

> `if (stripos($_GET['page'], $white_list) !== false)`

이런 코드로 whitelist에 있는 파일명으로 접근했는지 확인하는데 

존재하는지만 확인하기 때문에 index/../contents 이런식으로 접근할 수 있다.<br>

>>>>>>>>>>> 예압~ 바-통 트치 9reat

또 ?page=index/../functions 에 들가서 gen_hash_func 나 등등 조흔 인포메이션을 얻을 수 있당

contents.php 를 보게되면 아래오 같은 코-드를 볼 수 있는디
```php
if ($_POST['username'] && $_POST['password'] && !$_COOKIE['HACKINGCAMP']) {
   gen_hash_table();
   $prefix = base64_decode('czNzczFvbl9jMDBraWVf');
   $username = account($_POST);
   $f = fopen(dirname(__FILE__).'/account/'.$username.'.dat', 'r');
   $password = explode('/', fgets($f));
   $proofhash = $username == 'admin' ? $_COOKIE['HACKINGCAMP'] : $password[1];
   $hash = $salt.'|'.$username.':'.$password[0];
   if ($username == 'admin' && $_POST['password'] == $password[0] && gen_hash($hash) == $proofhash) {
      echo $flag;
   }else if ($username == 'guest' && $_POST['password'] == $password[0]) {
      echo '<h3>Hello '.$username.'!</h3>';
      setcookie("HACKINGCAMP", (substr(md5($prefix.gen_hash($hash)), 0, 0x18).gen_hash($hash)));
   }else die('<script type="text/javascript">alert("login failed..");location.href="./";</script>');
   echo '<p><img src="./img/'.($username == 'admin' ? 'admin.png' : 'guest.jpg').'" /></p>';
   fclose($f);
}  
```

```php
function gen_hash_table(){
   global $table;
   
   $poly = 0xdeadbeef;
   for ($i = 0x0; $i < 0x100; $i++) {
      $temp = $i;
      for ($j = 0; $j < 8; $j++) {
         if ($temp & 1)
            $temp = ($temp >> 1) ^ $poly;
         else
            $temp >>= 1;
      }
      $table[$i] = $temp;
   }
}
 
function gen_hash($string){
   global $table;
   $temp = 0;
   for ($i = 0; $i < strlen($string); $i++) 
      $temp = $table[ord($string[$i]) ^ ($temp & 0xff)] ^ ($temp >> 8);
   return dechex($temp);
}
```

2번째 줄은 보면 `gen_hash_table()` 인데 아래 보면 알겠지만 **crc32 알고뤼듬 table** 을 생성하는 거시다.

또 */account/admin.dat* 을 통해서 **1n5cun710us** 이 admin 비번인것도 알아내었소이다.

로-쥑은 정리하면 아래와 같다.

> CRC32($salt|guest:guest) == 뭐시기(주어짐)
>
> CRC32($salt|admin:1n5cun710us) == 뭘까용ㅎㅎ

빼애액! $salt 는 당연히 모로는디 고럼 어캐 저걸 구하지..? 알아도 모를거 같다...

하시는 분은 여기 ![띵글](http://anch0vy.tistory.com/60) 이 있으니 참고 해 보길 바란다 ㅎㅎ
~~(**절대 귀찮아서 그러는거 아님**)~~

#### 고럼 바로 **기술** 들어 갑니다~

### Solver
```python
from struct import *


# poly = 0xdeadbeef
table = (0, 3955309778, 1792607355, 2165848233, 3585214710, 1047737380, 3211463821, 1420439647, 373255219, 4261302497,
         2095474760, 2535937178, 3280823493, 676091927, 2840879294, 1117084780, 746510438, 3351241908, 1185405981,
         2909200591, 4190949520, 302902338, 2467681515, 2027219001, 977384533, 3514861703, 1352183854, 3143208188,
         4025728163, 70418545, 2234169560, 1860928522, 1493020876, 3007089694, 841266359, 3655698533, 2370811962,
         1720616168, 3885415489, 207061139, 1321393407, 2768494637, 605804676, 3487229014, 2607862793, 1890707675,
         4054438002, 443083936, 1954769066, 2671924344, 509242577, 4120596483, 2704367708, 1257266318, 3421004839,
         539580661, 1656489113, 2306685003, 140837090, 3819191344, 3071151215, 1557082301, 3721857044, 907424966,
         2986041752, 1513774410, 3676464611, 820205873, 1682532718, 2408076732, 244346133, 3847311815, 2814643627,
         1275408761, 3441232336, 651965698, 1920337245, 2578921871, 414122278, 4084088308, 2642786814, 1984202028,
         4150050181, 480084311, 1211609352, 2750844378, 586069363, 3375335841, 2344277453, 1618733343, 3781415350,
         178449764, 1577639227, 3049906665, 886167872, 3742426514, 3909538132, 46656902, 2212484399, 1746856445,
         1018485154, 3614827888, 1450040793, 3182223627, 4281974119, 351830453, 2514532636, 2116126158, 713799057,
         3242887491, 1079161322, 2878573880, 3312978226, 783889888, 2946567497, 1147154843, 281674180, 4211817750,
         2048067007, 2446473581, 3544671489, 948328915, 3114164602, 1381981608, 116747767, 3979628837, 1814849932,
         2280478046, 3735928559, 896303677, 3027548820, 1605731910, 186627609, 3772680907, 1640411746, 2315751088,
         3365065436, 592702990, 2722879143, 1233840757, 488692266, 4141999864, 2012864081, 2620973699, 4073940617,
         420633179, 2550817522, 1942707744, 660696703, 3433058989, 1303931396, 2792969942, 3840674490, 254621288,
         2385841857, 1710502419, 828244556, 3667869342, 1535575607, 2957392613, 2253393443, 1838232305, 3968404056,
         122173066, 1407321813, 3089316359, 960168622, 3539615356, 2423218704, 2075025090, 4206257771, 293034681,
         1172138726, 2921092660, 788819613, 3301265999, 2855196229, 1106242199, 3237466686, 725020396, 2140987059,
         2489180769, 356899528, 4270122522, 3155278454, 1473283748, 3603480077, 1024033503, 1772335744, 2187497042,
         58373883, 3904604713, 1867964279, 2224546725, 93313804, 3998148574, 3135559553, 1361439571, 3493712890,
         1006432040, 2036970308, 2460520342, 330348351, 4168190957, 2900081586, 1192920928, 3322068937, 767787803,
         1126696721, 2833857475, 703660906, 3257941944, 2526679015, 2103128885, 4232252316, 394409806, 1427598114,
         3201718256, 1070493529, 3557774219, 2158322644, 1801740038, 3934021551, 29186941, 933982139, 3697955689,
         1567779776, 3065206546, 3793315661, 165174175, 2294309686, 1661034468, 563348360, 3394584410, 1263339507,
         2693544737, 4096134014, 535246764, 2667515653, 1967010775, 466991069, 4027878159, 1896657830, 2597162868,
         3462905643, 631669753, 2763963216, 1333757826, 233495534, 3861636924, 1731452821, 2364728135, 3629699864,
         865726410, 2994853731, 1497426865)

# table << 56
untable = (0, 235, 106, 129, 213, 62, 191, 84, 22, 253, 124, 151, 195, 40, 169, 66, 44, 199, 70, 173, 249, 18, 147, 120, 58,
    209, 80, 187, 239, 4, 133, 110, 88, 179, 50, 217, 141, 102, 231, 12, 78, 165, 36, 207, 155, 112, 241, 26, 116, 159,
    30, 245, 161, 74, 203, 32, 98, 137, 8, 227, 183, 92, 221, 54, 177, 90, 219, 48, 100, 143, 14, 229, 167, 76, 205, 38,
    114, 153, 24, 243, 157, 118, 247, 28, 72, 163, 34, 201, 139, 96, 225, 10, 94, 181, 52, 223, 233, 2, 131, 104, 60,
    215, 86, 189, 255, 20, 149, 126, 42, 193, 64, 171, 197, 46, 175, 68, 16, 251, 122, 145, 211, 56, 185, 82, 6, 237,
    108, 135, 222, 53, 180, 95, 11, 224, 97, 138, 200, 35, 162, 73, 29, 246, 119, 156, 242, 25, 152, 115, 39, 204, 77,
    166, 228, 15, 142, 101, 49, 218, 91, 176, 134, 109, 236, 7, 83, 184, 57, 210, 144, 123, 250, 17, 69, 174, 47, 196,
    170, 65, 192, 43, 127, 148, 21, 254, 188, 87, 214, 61, 105, 130, 3, 232, 111, 132, 5, 238, 186, 81, 208, 59, 121,
    146, 19, 248, 172, 71, 198, 45, 67, 168, 41, 194, 150, 125, 252, 23, 85, 190, 63, 212, 128, 107, 234, 1, 55, 220,
    93, 182, 226, 9, 136, 99, 33, 202, 75, 160, 244, 31, 158, 117, 27, 240, 113, 154, 206, 37, 164, 79, 13, 230, 103,
    140, 216, 51, 178, 89)


def crc(c, crc_):
    return table[(crc_ & 0xff) ^ c] ^ (crc_ >> 8)


def uncrc(c, crc_):
    i = untable.index(crc_ >> 24)
    crc_ ^= table[i]
    crc_ = (crc_ << 8) & 0xffffffff
    crc_ += i ^ c
    return crc_


salt = 'debukuk_1s_hands0me'
userpw = "guest" + ":" + "guest"
auserpw = "admin" + ":" + "1n5cun710us"
h = salt + '|' + userpw

un = 0
for x in h:
    un = crc(ord(x), un)

print("[*] crc(salt|guest:guest) is            : " + hex(un))

for x in userpw[::-1]:
    un = uncrc(ord(x), un)

print("[*] crc(salt|) is                       : %#x" % un)

for x in auserpw:
    un = crc(ord(x), un)

print("[+] crc(salt|admin:1n5cun710us) is      : %#x" % un)

# assert # for checking
un = 0
for x in "debukuk_1s_hands0me|admin:1n5cun710us":
    un = crc(ord(x), un)

print("[Assert] crc(salt|admin:1n5cun710us) is : %#x" % un)

```

요러면 admin 계정에 필요한 crc 값을 구할 수 있땅 :)

>>>>>>>>>>>> 다쉬 바통 트-치

이제 플래그를 얻으면 되는데 
> `if ($_POST['username'] && $_POST['password'] && !$_COOKIE['_token']) {`
 
이 조건문을 우회할 방법은 없으므로

(왜냐하면 _token 쿠키가 없어야하는데 조건문안에서는 username이 admin일 경우 _token 쿠키를 사용하여 password[1]을 대체하기 때문입니다.)<br>
<br>
> `if ($_COOKIE['_token']) {`

이 조건문을 통해서 플래그를 얻어야한다.<br>
그냥 단순히 쿠키에 얻은 해쉬를 넣으면 플래그를 얻을 수 있다.<br>
<br>
Flag : Demon{im_n0t_p4ngh0_1m_hyun9ch4nz_L0L}<br>